<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/styles.css">
  <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700' rel='stylesheet' type='text/css'>
  <script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
  <script src="http://d3js.org/queue.v1.min.js"></script>
  <script src="js/mbta-svg.js"></script>
</head>

<body>
  <div class="container">
    <h1>Exploring Boston Food by MBTA</h1>
  </div>


 <div class="row">
    <div class="col-md-9" id="test">
    </div>

  <label>Scale Circles By: </label>
  <select id="mySelectOption" onchange="rank()"> 
    <option value="none"selected>Stop</option>
    <option value="count">Count</option>
    <option value="average_rating" >Avg. Rating</option>
    <option value="total_reviews" >Tot. Reviews</option>
  </select>

  <label> Display Line: </label>
  <select id="mySelectLine" onchange="line_display()"> 
    <option value="none"selected>None</option>
    <option value="red">Red</option>
    <option value="green">Green</option>
    <option value="orange" >Orange</option>
    <option value="blue" >Blue</option>
  </select>

</div>


<svg id="mbta_svg"
   xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 1947 1825"
   enable-background="new 0 0 1947 1825" xml:space="preserve">
   <script>document.write(mbta_svg)</script>
   <g id="circles"></g>
</svg>


<script type="text/javascript">

   //Global Variables
   var metaData;
   var allData;
   var stop_list = [];  //Aggregate data list
   var radius_scale = d3.scale.linear().range([10,60]);
   var circles = d3.selectAll('circle')

     //List of all possible categories
  var category_list = ["Afghan", "African", "American (New)", "American (Traditional)", "Arabian", "Argentine",
  "Armenian", "Asian Fusion", "Australian", "Austrian", "Bangladeshi", "Barbeque", "Basque",
  "Belgian", "Brasseries", "Brazilian", "Breakfast & Brunch", "British", "Buffets", "Burgers",
  "Burmese", "Cafes", "Cafeteria", "Cajun/Creole", "Cambodian", "Cantonese", "Caribbean",
  "Catalan", "Cheesesteaks", "Chicken Shop", "Chicken Wings", "Chinese", "Colombian","Comfort Food",
  "Creperies", "Cuban", "Czech", "Delis", "Dim Sum", "Diners", "Dominican", "Egyptian", "Ethiopian",
  "Falafel", "Fast Food", "Filipino", "Fish & Chips", "Fondue", "Food Court", "Food Stands", "French",
  "Gastropubs", "German", "Gluten-Free", "Greek", "Haitian", "Halal", "Hawaiian","Himalayan/Nepalese",
  "Hot Dogs", "Hot Pot", "Hungarian", "Iberian", "Indian", "Indonesian", "Irish", "Italian", "Japanese",
  "Korean", "Kosher", "Laotian", "Latin American", "Lebanese", "Live/Raw Food", "Malaysian", "Mediterranean",
  "Mexican", "Middle Eastern", "Modern European", "Mongolian", "Moroccan", "Pakistani", "Persian/Iranian",
  "Peruvian", "Pizza", "Polish", "Portuguese", "Poutineries", "Puerto Rican", "Ramen", "Russian", "Salad",
  "Salvadoran", "Sandwiches", "Scandinavian", "Scottish", "Seafood", "Senegalese", "Shanghainese", "Singaporean",
  "Slovakian", "Soul Food", "Soup", "South African", "Southern", "Spanish", "Sri Lankan", "Steakhouses",
  "Sushi Bars", "Szechuan", "Taiwanese", "Tapas Bars", "Tapas/Small Plates", "Teppanyaki", "Tex-Mex", "Thai",
  "Trinidadian", "Turkish", "Ukrainian", "Uzbek", "Vegan", "Vegetarian", "Venezuelan","Vietnamese"]


   //Initialize circles using metadata
   var initVis = function(){

      metaData.forEach(function(stop){

         d3.select("#circles").append('circle')
            .attr("cx", stop['x'])
            .attr("cy", stop['y'])
            .attr("r", 25)
            .attr("class", function(){
               if(stop.line.length == 1){
                  return stop.line[0];
               } else{
                  return stop.line[0] + ' ' + stop.line[1]
               }
            })
            .attr("id", stop["station"])
            .datum(stop);

      })


      //Call function to calculate totals
      aggregateTotals()
   }


   //check if there is an error, store data in global variables
   var dataLoaded = function (error, _metaData, _allData) {

      if (!error) {

         allData = _allData
         metaData = _metaData

         console.log("metaData", metaData);
         console.log("allData", allData)


         initVis();

      }

   }


   //Start the dataload
   var startHere = function(){

       // Load data here and call "dataLoaded" afterwards
       // Hint: http://giscollective.org/d3-queue-js/
       queue()
           .defer(d3.json, '../data/mbta_metadata.json') // AllData
           .defer(d3.json, '../data/data.json') // Contains meta-information about AllData. 
           .await(dataLoaded); // Call dataLoaded function

   }




   //Aggregate the values for count and average ratings
   var aggregateTotals = function(){

      //object with categories initialized to 0
      var initialized_cat= {}

        category_list.forEach(function(category){
          initialized_cat[category] = 0
        })

      console.log("initial", initialized_cat)

     //create blank array of objects containing agregate information for each t-stop
      stop_list = metaData.map(function(d){

      temp = {  id: d.stop_id,
                line: d.line[0],
                count:0,
                rating_average:0,
                review_count:0,
                category: initialized_cat
             }  

      return temp   

     })

    //////////////////


      //loop through every restaurant and calculate the total numbers per stop
      allData.forEach(function(restaurant){
        stop_list.forEach(function(stop){

          if(restaurant.stop_id == stop.id){
            stop.count += 1;  //total count
            stop.rating_average += restaurant.rating  //total ratings
            stop.review_count += restaurant.review_count
            var temp_cat = restaurant.categories[0]
            stop.category[temp_cat] += 1

            // restaurant.categories.forEach(function(cat){
            //   //console.log("cat", cat)
            //   stop.category[cat]+= 1;
            // })

          }

        })
      })



      //divide by number of restaurants in the given stop to create averages when necessary
      stop_list.forEach(function(stop){
        stop.rating_average = stop.rating_average / stop.count;

      })

      console.log("stop list", stop_list)
  }


  //Scale the circles based on the Count, Average Rating, etc.
  function rank(){

   var e = document.getElementById("mySelectOption");
   var plot_variable = e.options[e.selectedIndex].value;
   console.log(plot_variable)
   var max_count = d3.max(stop_list, function(d){ return d.count });
   //var max_avg = d3.max(stop_list, function(d){ return d.rating_average });
   //var max_comments = d3.max(stop_list, function(d){ return d.review_count });
   var plot = stop;


   //Find the domain for the given selection
   if(plot_variable == "count"){
    radius_scale.domain([0, max_count]) 
    plot = "count"
   }
   else if(plot_variable == "average_rating"){
    radius_scale.domain(d3.extent(stop_list, function(d){ return d.rating_average}))
    plot = "rating_average"
   }
   else if(plot_variable == "total_reviews"){
    radius_scale.domain(d3.extent(stop_list, function(d){ return d.review_count}))
    plot = "review_count"
   } 
   else {plot = "stop"}


    d3.selectAll('circle').attr("r", function(d){

      var plot_r; //value of plotted radius

      //if stop is selected return radius of 10
      if(plot == "stop"){ return 10}
      else {

      //Loop through stops and set radius value based on matching stop id's
      stop_list.forEach(function(stop){
        if(stop.id == d.stop_id){
          plot_r = radius_scale(stop[plot]) 
        }
      })

      return plot_r;

    }
    })

  }


  //Function to control highlight of specific lines
  function line_display(){

   var e = document.getElementById("mySelectLine");
   var select_line = e.options[e.selectedIndex].value;

   d3.selectAll('circle').style("opacity", .5)

   var line = d3.selectAll('.' + select_line);

   line.style("opacity", 1);

  }

   startHere()


</script>
</body>
</html>